package com.broadtech.analyse.flink.source.cmcc;

import com.broadtech.analyse.pojo.cmcc.Vulnerability;
import com.mysql.cj.jdbc.Driver;
import org.apache.flink.configuration.Configuration;
import org.apache.flink.streaming.api.functions.source.RichSourceFunction;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.HashMap;
import java.util.Map;

/**
 * @author leo.J
 * @description 从mysql读取漏洞库数据
 * @date 2020-04-26 17:16
 */
public class VulnerabilityReader extends RichSourceFunction<Map<String, Vulnerability>> {
    private static final Logger LOG = LoggerFactory.getLogger(VulnerabilityReader.class);

    private Connection connection = null;
    private PreparedStatement ps = null;
    private volatile boolean isRunning = true;

    private String jdbcUrl;
    private String userName;
    private String password;

    public VulnerabilityReader(String jdbcUrl, String userName, String password) {
        this.jdbcUrl = jdbcUrl;
        this.userName = userName;
        this.password = password;
    }

    /**
     * 打开jdbc连接
     *
     * @param parameters
     * @throws Exception
     */
    @Override
    public void open(Configuration parameters) throws Exception {
        super.open(parameters);
        DriverManager.registerDriver(new Driver());
        connection = DriverManager.getConnection(jdbcUrl, userName, password);//获取连接
        String sql = "select * from vulnerability";
        ps = connection.prepareStatement(sql);

    }

    /**
     * 按天更新
     * @param ctx
     * @throws Exception
     */
    public void run(SourceContext<Map<String, Vulnerability>> ctx) throws Exception {
        Map<String, Vulnerability> valnerabilityMap = new HashMap<>();
        while (isRunning) {
            ResultSet rs = ps.executeQuery();
            while (rs.next()) {
                String description = rs.getString("description");
                String discoverername = rs.getString("discoverername");
                String formalway = rs.getString("formalway");
                String isevent = rs.getString("isevent");
                String number = rs.getString("number");
                String opentime = rs.getString("opentime");
                String patchdescription = rs.getString("patchdescription");
                String patchname = rs.getString("patchname");
                String product = rs.getString("product");
                String serverity = rs.getString("serverity");
                String submittime = rs.getString("submittime");
                String title = rs.getString("title");
                Vulnerability vulnerability = new Vulnerability();
                vulnerability.setDescription(description);
                vulnerability.setDiscoverername(discoverername);
                vulnerability.setFormalway(formalway);
                vulnerability.setIsevent(isevent);
                vulnerability.setNumber(number);
                vulnerability.setOpentime(opentime);
                vulnerability.setPatchdescription(patchdescription);
                vulnerability.setPatchname(patchname);
                vulnerability.setServerity(serverity);
                vulnerability.setSubmittime(submittime);
                vulnerability.setTitle(title);
                valnerabilityMap.put(product, vulnerability);
            }
            ctx.collect(valnerabilityMap);
            valnerabilityMap.clear();
            //设置多久查询更新mysql数据
            Thread.sleep(1 * 24 * 60 * 60 * 1000);
        }
    }

    public void cancel() {
        try {
            super.close();
            if (connection != null) {
                connection.close();
            }
            if (ps != null) {
                ps.close();
            }
        } catch (Exception e) {
            LOG.error("runException{}", e);
        }
        isRunning = false;
    }
}
