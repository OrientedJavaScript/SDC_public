package com.broadtech.vulnerability.task;

import com.broadtech.vulnerability.bean.CveVulnerability;
import com.broadtech.vulnerability.bean.IpsXinnuo;
import com.broadtech.vulnerability.units.DBUtils;
import com.broadtech.vulnerability.units.TimeUtils;
import com.csvreader.CsvReader;
import org.apache.commons.dbcp.BasicDataSource;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.charset.Charset;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.util.ArrayList;

/**
 * @author jiangqingsong
 * @description 解析Ips(上海欣诺)数据入mysql
 * 1、文件来源是csv格式
 * @date 2020-09-18 10:27
 */
public class LoadIps2Db {

    private PreparedStatement ps;
    private BasicDataSource dataSource = new BasicDataSource();;
    private Connection connection;
    private String jdbcUrl = "jdbc:mysql://localhost:3308/sdc?characterEncoding=UTF-8&serverTimezone=UTC";
    private String userName = "root";
    private String password = "broadtech";
    private String sql = "insert into brd_test_ips(time,device,attack_technique,even_name,src_ip,action,rule_id," +
            "even_times,protocol,pop_level,danger_level,service_type,net_interface,vlan_id,dest_ip,src_mac,dest_mac," +
            "src_port,dest_port,origin_message)" +
            "values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
    public static void main(String[] args) throws Exception {
        LoadIps2Db loadCve2Db = new LoadIps2Db();
        loadCve2Db.readCsv2Db();
    }

    public void readCsv2Db() throws Exception {
        // 用来保存数据
        ArrayList<String[]> csvFileList = new ArrayList<String[]>();
        String csvFilePath = "D:\\SDC\\data\\9月底需求\\测试用例要求的积累数据包\\流量告警及流量日志\\ipslog_1569563443（上海欣诺）.xls";

        connection = DBUtils.getCon(dataSource, jdbcUrl, userName, password);
        ps = this.connection.prepareStatement(sql);
        try {
            CsvReader reader = new CsvReader(csvFilePath, ',', Charset.forName("UTF-8"));
            reader.readHeaders();
            while (reader.readRecord()) {
                //System.out.println(reader.getRawRecord());
                csvFileList.add(reader.getValues());
            }
            reader.close();
            // 遍历读取的CSV文件
            for (int row = 1; row < csvFileList.size(); row++) {
                // 取得第row行第0列的数据
                //获取每行数据&&
                String[] cveLines = csvFileList.get(row);
                String time = cveLines[0];
                String device = cveLines[1];
                String attack_technique = cveLines[2];
                String even_name = cveLines[3];
                String src_ip = cveLines[4];
                String action = cveLines[5];
                String rule_id = cveLines[6];
                String even_times = cveLines[7];
                String protocol = cveLines[8];
                String pop_level = cveLines[9];
                String danger_level = cveLines[10];
                String service_type = cveLines[11];
                String net_interface = cveLines[12];
                String vlan_id = cveLines[13];
                String dest_ip = cveLines[14];
                String src_mac = cveLines[15];
                String dest_mac = cveLines[16];
                String src_port = cveLines[17];
                String dest_port = cveLines[18];
                String origin_message = cveLines[19];
                IpsXinnuo ipsXinnuo = new IpsXinnuo(time,device,attack_technique,even_name,src_ip,action,rule_id,even_times,
                        protocol,pop_level,danger_level,service_type,net_interface,vlan_id,dest_ip,src_mac,dest_mac,src_port,
                        dest_port,origin_message);
                saveDb(ipsXinnuo);
            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void saveDb(IpsXinnuo vuln) throws Exception {
        ps.setString(1, vuln.getTime());
        ps.setString(2, vuln.getDevice());
        ps.setString(3, vuln.getAttack_technique());
        ps.setString(4, vuln.getEven_name());
        ps.setString(5, vuln.getSrc_ip());
        ps.setString(6, vuln.getAction());
        ps.setString(7, vuln.getRule_id());
        ps.setString(8, vuln.getEven_times());
        ps.setString(9, vuln.getProtocol());
        ps.setString(10, vuln.getPop_level());
        ps.setString(11, vuln.getDanger_level());
        ps.setString(12, vuln.getService_type());
        ps.setString(13, vuln.getNet_interface());
        ps.setString(14, vuln.getVlan_id());
        ps.setString(15, vuln.getDest_id());
        ps.setString(16, vuln.getSrc_mac());
        ps.setString(17, vuln.getDest_mac());
        ps.setString(18, vuln.getSrc_port());
        ps.setString(19, vuln.getDest_port());
        ps.setString(20, vuln.getOrigin_message());
        ps.execute();
    }
}
