package com.broadtech.vulnerability.task;

import com.broadtech.vulnerability.bean.CveVulnerability;
import com.broadtech.vulnerability.units.DBUtils;
import com.broadtech.vulnerability.units.TimeUtils;
import com.csvreader.CsvReader;
import org.apache.commons.dbcp.BasicDataSource;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.charset.Charset;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.util.ArrayList;

/**
 * @author leo.J
 * @description 解析cve数据入mysql
 * 1、文件来源是csv格式
 * @date 2020-09-18 10:27
 */
public class LoadCve2Db {

    private PreparedStatement ps;
    private BasicDataSource dataSource = new BasicDataSource();;
    private Connection connection;
    private String jdbcUrl = "jdbc:mysql://master01:3306/sdc?characterEncoding=UTF-8&serverTimezone=UTC";
    private String userName = "root";
    private String password = "broadtech";
    private String sql = "insert into brd_cve_vulnerability(number, status, description, reference, phase, votes, comments,update_time)" +
            "values(?,?,?,?,?,?,?,?)";
    public static void main(String[] args) throws Exception {
        LoadCve2Db loadCve2Db = new LoadCve2Db();
        loadCve2Db.readCsv2Db();
    }

    public void readCsv2Db() throws Exception {
        // 用来保存数据
        ArrayList<String[]> csvFileList = new ArrayList<String[]>();
        String csvFilePath = "D:\\SDC\\data\\9月底需求\\测试用例要求的积累数据包\\CVE漏洞库\\allitems.csv";

        connection = DBUtils.getCon(dataSource, jdbcUrl, userName, password);
        ps = this.connection.prepareStatement(sql);
        try {
            String updateTime = TimeUtils.convertTimestamp2Date(System.currentTimeMillis(), "yyyy-MM-dd hh:mm:ss");
            CsvReader reader = new CsvReader(csvFilePath, ',', Charset.forName("UTF-8"));
            reader.readHeaders();
            while (reader.readRecord()) {
                System.out.println(reader.getRawRecord());
                csvFileList.add(reader.getValues());
            }
            reader.close();
            // 遍历读取的CSV文件
            for (int row = 10; row < csvFileList.size(); row++) {
                // 取得第row行第0列的数据
                //获取每行数据&&
                String[] cveLines = csvFileList.get(row);
                //name	status	description	references	phase	votes	comments
                String number = cveLines[0];
                String status = cveLines[1];
                String description = cveLines[2];
                String references = cveLines[3];
                String phase = cveLines[4];
                String votes = cveLines[5];
                String comments = cveLines[6];
                CveVulnerability cveVulnerability = new CveVulnerability(number, status, description, references, phase, votes, comments);
                saveDb(updateTime, cveVulnerability);
            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void saveDb(String updateTime, CveVulnerability vuln) throws Exception {
        ps.setString(1, vuln.getName());
        ps.setString(2, vuln.getStatus());
        ps.setString(3, vuln.getDescription());
        ps.setString(4, vuln.getReferences());
        ps.setString(5, vuln.getPhase());
        ps.setString(6, vuln.getVotes());
        ps.setString(7, vuln.getComments());
        ps.setString(8, updateTime);
        ps.execute();
    }
}
